---
title: "Data Science for Economists"
# subtitle: "<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>"
subtitle: "Lecture 13: Docker"
author: "Grant McDermott"
date: "University of Oregon | [EC 607](https://github.com/uo-ec607)" #"`r format(Sys.time(), '%d %B %Y')`"
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts] 
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      highlightSpans: true
      countIncrementalSlides: false
---
name: toc

```{css, echo=FALSE}
@media print {
  .has-continuation {
    display: block !important;
  }
}
.large4 { font-size: 400% }
.large2 { font-size: 200% }
.small90 { font-size: 90% }
.small75 { font-size: 75% }
```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(knitr)
opts_chunk$set(
  eval = FALSE, ## Turn off eval for this deck!
  prompt = TRUE, ## See hook below. I basically want a "$" prompt for every bash command in this lecture.
  fig.align="center", #fig.width=6, fig.height=4.5, 
  # out.width="748px", #out.length="520.75px",
  dpi=300, #fig.path='Figs/',
  cache=F#, echo=F, warning=F, message=F
  )
## Next hook based on this SO answer: https://stackoverflow.com/a/39025054
knit_hooks$set(
  prompt = function(before, options, envir) {
    options(
      prompt = if (options$engine %in% c('sh','bash')) '$ ' else 'R> ',
      continue = if (options$engine %in% c('sh','bash')) '$ ' else '+ '
      )
})
```

# Table of contents

1. [Prologue](#prologue)

2. [Docker 101](#intro)

3. [Examples](#examples)
  
  - [Base R](#r-base)
  - [RStudio+](#rstudio+)

4. [Sharing files with a container](#share)

5. [Next steps](#next)

---
class: inverse, center, middle
name: prologue

# Prologue

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

---

# Install Docker

- [Linux](https://docs.docker.com/engine/install)

- [Mac](https://docs.docker.com/docker-for-mac/install/)

- Windows (install varies by version)
  - [Windows 10 Pro / Education / Enterprise](https://docs.docker.com/docker-for-windows/install/)
  - [Windows 10 Home](https://docs.docker.com/docker-for-windows/install-windows-home/)
  - [Windows 7 / 8](https://docs.docker.com/toolbox/toolbox_install_windows/)

---
class: inverse, center, middle
name: intro

# Docker 101
<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

---

# What is a container?

Have you ever...

- tried to install a program or run someone else's code, only to be confronted by a bunch of error messages?
- shared your code and data with someone else, only for them to be confronted by error messages?
- re-run your own analyses after a major package update, only to find that the code no longer works or the results have changed?

--

Containers are way to solve these (and many other) problems.

--

### Docker

By far the most widely used and best supported container technology.
- Certainly true for the types of problems that we are concerned with in this course.
- So, while there are other container platforms around, when I talk about "containers" in this lecture, I'm really talking about [**Docker**](https://www.docker.com/). 

---

# Why do we care?

I've already prompted some of the main reasons on the previous slide. But to sum things up with two ideas:

### 1. Reproducibility

If we can bundle our code and software in a Docker container, then we don't have to worry about it not working on someone else's system (and vice versa). Similarly, we don't have to worry about it not working on our own systems in the future (e.g. after package or program updates).

### 2. Deployment

There are many deployment scenarios (packaging, testing, etc.). Of particular interest to this course are data science pipelines where you want to deploy software quickly and reliably. Need to run some time-consuming code up on the cloud? Save time and installation headaches by running it through a suitable container, which can easily be deployed to a cluster of machines too.

---

# The analogy

You know those big shipping containers used to transport physical goods?

.pull-left[
![Source: https://www.pangeacontainers.nl/](pics/containerschip2.jpg)
]

.pull-right[
![](pics/container-truck.jpg)
]

They provide a standard format that can accommodate all manner of goods (TVs, fresh produce, whatever). Not only that, but they are stackable and can easily be switched between different modes of transport (ship, road, rail).

--

Docker containers are the software equivalent. 
- physical goods <-> software
- transport modes <-> operating systems
- etc.

---

# How it works

1. Start off with a stripped-down version of an operating system. Usually a Linux distro like Ubuntu.

2. Install _all_ of the programs and dependencies that are needed to run your code.

3. (Add any extra configurations you want.)

4. Package everything up as a [tarball](https://en.wikipedia.org/wiki/Tar_%28computing%29).<sup>*</sup>

.footnote[
<sup>*</sup> A format for storing a bunch of files as a single object. Can also be compressed to save space.
]

--

</br>

**Summary:** Containers are like mini, portable operating systems that contain everything needed to run some piece of software (but nothing more!). 

---

# The big idea

![](pics/b0rk_zine.jpg)

.pull-right[*Credit: [Julia Evans](https://twitter.com/b0rk/status/1237464479811633154). (Buy the [zine](https://wizardzines.com/zines/containers/)!)*]

---

# Quick terminology clarification

*Image* ~ This is the tarball that we talked about on the previous two slides. It is a set of layers and instructions for building a container.

*Container* ~ A container is a running instance of an image. You can have many containers (i.e. running instances) of the same image.

--

</br>

**Analogy:** Think of the image as the recipe and the container as the cake. You can use the recipe to make many versions of the same cake (even if you only ever plan to make one). And you can share the recipe with others to make their own cake.

---

# Rocker = R + Docker

It should now be clear that Docker is targeted at (and used by) a bewildering array of software applications.

In the realm of economics and data science, that includes every major open-source programming language and software stack.<sup>1</sup> For example, you could download and run a [Julia container](https://hub.docker.com/_/julia/) right now if you so wished.

.footnote[<sup>1</sup> It's possible to build a Docker image on top of proprietary software ([example](https://github.com/mathworks-ref-arch/matlab-dockerfile)). But license restrictions make this complicated. I've rarely ever see it done in practice.]

--

But for this course, we are primarily concerned with Docker images that bundle R applications.

The good news is that R has outstanding Docker support, primarily thanks to the **Rocker Project** ([website](https://www.rocker-project.org/) / [GitHub](https://github.com/rocker-org/rocker)).
- For the rest of today's lecture we will be using images from Rocker (or derivatives).


---
class: inverse, center, middle
name: examples

# Examples
<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

---
name: r-base

# Example 1: Base R

For our first example, let's fire up a simple container that contains little more than a base R installation.

```{bash}
docker run --rm -it rocker/r-base
```

This will take a little while to download the first time. But afterwards the container will be ready and waiting for immediate deployment ("instantiation") on your system. 

--

</br>
A quick note on these `docker run` flags:

- `--rm` Automatically remove the container once it exits (i.e. clean up).
- `-it` Launch with interactive (`i`) shell/terminal (`t`).
- For a full list of flag options, see [here](https://docs.docker.com/engine/reference/run).

---

# Example 1: Base R (cont.)

To see a list of running containers on your system, in a new terminal window type:

```{bash}
docker ps
```

You should see something like:

```sh
CONTAINER ID   IMAGE           COMMAND   CREATED          STATUS          PORTS     NAMES
1fcdee074beb   rocker/r-base   "R"       35 seconds ago   Up 35 seconds             competent_elion
```

--

The container ID (here: "1fcdee074beb") is probably the most important bit of information.
- We'll be using container IDs later in the lecture. For now, just remember that you can grab them with the `$ docker ps` command.

---

# Example 1: Base R (cont.)

Your base R container should have launched directly into R. Feel feel to kick the tyres. Run a regression on the mtcars dataset, do some addition, etc.

--

To exit the container, simply quit R.

```{r}
q()
```

Check that it worked:

```{bash}
docker ps
```

--

BTW, if you don't want to launch directly into your container's R console, you can instead start it in the bash shell.

```{bash}
docker run --rm -it rocker/r-base /bin/bash
```

This time to close and exit the container, you need to exit the shell, e.g.

```
root@09dda673a187:/# exit
```

---
name: rstudio+

# Example 2: RStudio+

The Rocker Project works by layering Docker images on top of each other in a [grouped stack](https://github.com/rocker-org/rocker#use-cases). An important group here is the [**versioned**](https://github.com/rocker-org/rocker-versioned2#version-stable-rocker-images-for-r--400) stack.

![](pics/rocker-versioned.png)
--

Allows us to easily spin up different versions of R (3.6.1, 4.0.2, etc), plus extra layers.

---

# Example 2: RStudio+ (cont.)

Let's try the [`tidyverse`](https://hub.docker.com/r/rocker/tidyverse) image from this versioned stack, which layers base R + RStudio + tidyverse. I'll specify R 4.0.0 as my base image.

*Again, this next line will take a minute or three to download and extract the first time. But the container will be ready for immediate deployment on your system thereafter.*

---
count: false

# Example 2: RStudio+ (cont.)

Let's try the [`tidyverse`](https://hub.docker.com/r/rocker/tidyverse) image from this versioned stack, which layers base R + RStudio + tidyverse. I'll specify R 4.0.0 as my base image.

```{bash}
docker run -d -p 8787:8787 -e PASSWORD=mypassword rocker/tidyverse:4.0.0
```

- `-d` Detach (i.e. run as background process).
- `-p 8787:8787` Share a port with the host computer's browser.
- `-e PASSWORD=mypassword` Password for logging on to RStudio Server.
- `rocker/tidyverse:4.0.0` Use the [`tidyverse`](https://hub.docker.com/r/rocker/tidyverse) image built on top of R 4.0.0.

--

If you run this... nothing seems to happen. Don't worry, I'll explain on the next slide.

- Confirm for yourself that it's actually running with `$ docker ps`. (Mac and Windows users should definitely do this because you'll need the container ID shortly.)

--
name:username

**Aside.** All RStudio(+) images in the Rocker stack require a password. Pretty much anything you want except "rstudio", which is the default username. On that note, if you don't like the default "rstudio" username, you can choose your own by adding `-e USER=myusername` to the above command.

---

# Example 2: RStudio+ (cont.)

Unlike, the "r-base" container, this time we aren't immediately taken to our R environment.

**Reason:** Our container is running RStudio Server, which needs to be opened up in a browser.

--

So we need to point our browsers to the relevant IP address _plus_ the opened `:8787` port:
- **Linux:** http://localhost:8787 
- **Mac/Windows:** Type in `$ docker inspect <containerid>  | grep IPAddress` to get your address (see [here](https://stackoverflow.com/a/46310428)). Note that this information was also displayed when you first launched your Docker Quickstart Terminal. For example:

.small75[
  
  ```
                          ##         .
                    ## ## ##        ==
                 ## ## ## ## ##    ===
             /"""""""""""""""""\___/ ===
        ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
             \______ o           __/
               \    \         __/
                \____\_______/
  
  
  docker is configured to use the default machine with IP `192.168.99.100`
  For help getting started, check out the docs at https://docs.docker.com
  ```
]

--

So this Mac/Windows user would point their browser to http://192.168.99.100:8787.

---

# Example 2: RStudio+ (cont.)

Here's the login-in screen that I see when I navigate my browser to the relevant URL.

![](pics/rocker-rstudio-login.png)
--

Sign in with your "rstudio" + "mypassword" credential combination.

---

# Example 2: RStudio+ (cont.)

And here I am in RStudio Server running through Docker! (Pro-tip: Hit F11 to go full-screen.)

![](pics/rocker-rstudio.png)
---
count: false

# Example 2: RStudio+ (cont.)

I can also load the **tidyverse** straight away. (We can ignore those warning messages.)

![](pics/rocker-rstudio-tidyverse.png)



---

# Example 2: RStudio+ (cont.)

To stop this container, open up a new terminal window and grab the container ID with `$ docker ps`. Then run:

```{bash}
docker stop <containerid>
```

--

</b>

**Aside:** Recall that we instantiated this container as a detached/background process (`-d`).

```{bash}
docker run `-d` -p 8787:8787 -e PASSWORD=mypassword rocker/tidyverse
```

If you dropped the `-d` flag and re-ran the above command, your terminal would stay open as an ongoing process. (Try this yourself.)
- Everything else would remain the same. You'd still navigate to `<IPADDRESS>:8787` to log in, etc.
- However, I wanted to mention this non-background process version because it offers another way to shut down the container: Simply type `CTRL+c` in the (same, ongoing process) Terminal window. Again, try this yourself.
- Confirm that the container is stopped by running `$ docker ps`.

---

# Example 2: RStudio+ (cont.)

I'll end this example by reiterating the stacked (or _layered_) nature of the Docker workflow. 

To prove this, consider what happens what happens when I instantiate the [`r-ver:4.0.0`](https://hub.docker.com/r/rocker/r-ver) image at the base of Rocker's versioned stack.

--

![](pics/r-dev-4_0_0.png)
---

# Example 2: RStudio+ (cont.)

I'll end this example by reiterating the stacked (or _layered_) nature of the Docker workflow. 

To prove this, consider what happens what happens when I instantiate the [`r-ver:4.0.0`](https://hub.docker.com/r/rocker/r-ver) image at the base of Rocker's versioned stack.

**TL;DR** I am immediately taken into a running R 4.0.0 container.

- All those messages &mdash; `a4a2a29f9ba4: Already exists` etc. &mdash; are Docker confirming that it already has the necessary layers for building this (parent) container.
- No need to download or build any new layers.

--

This layered approach is not unique to the Rocker stack. It is integral to Docker's core design.
- Cache existing layers. Only (re)build what we have to do.
- Modularity reduces build times, makes containers easy to share and customize.

--

We'll return to these ideas at the end of the lecture.

---
class: inverse, center, middle
name: share

# Sharing files with a container
<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

---

# Share files by mounting volumes

Each container runs in a sandboxed environment and cannot access other files and directories on your computer unless you give it explicit permission.

To share files with a container, the `-v` (mount volume) flag is your friend. 
- Adopts a `LHS:RHS` convention, where `LHS` = `path/on/your/computer/` and `RHS` = `path/on/the/container`.

--

</br>

For example, say I have a folder on my computer located at `/home/grant/coolproject`. I can make this available to my "tidyverse" container by running: 

```{bash}
docker run `-v /home/grant/coolproject:/home/rstudio/coolproject` -d -p 8787:8787 -e PASSWORD=mypassword rocker/tidyverse
```

--

</br>

PS &mdash; I'll get back to specifying the correct RHS path in a couple slides.

---

# coolproject

The coolproject directory is now available from RStudio running on the container.

![](pics/rocker-rstudio-share.png)

---

# Choosing the RHS mount point

In the previous example, I specified the RHS mount point as `/home/rstudio/coolproject`. How did I know this would work?

--

The short answer is that `/home/rstudio` is the default user's home directory for images in the RStudio+ stack. If you're running a container from this stack, you should almost always start your RHS with this path root.
- Exception: If you assigned a different default user than "rstudio" ([back here](#username)). 

--

We have to be be specific about mounting under the user's home directory, because RStudio Server limits how and where users can access files. (This is a security feature that we'll revisit in the next lecture on cloud computing.)

--

OTOH the `/coolproject` directory name is entirely optional. Call it whatever you want... though using the same name as the linked computer directory obviously avoids confusion.
- Similarly, you're free to add a couple of parent directories. I could have used `-v /home/grant/coolproject:/home/rstudio/parentdir1/parentdir2/coolproject` and it would have worked fine.

---

# Choosing the RHS mount point (cont.)

Choosing a specific RHS mount point is less important for non-RStudio+ containers.


Still, be aware that the `/home/rstudio` path won't work for our r-base container from earlier.
- Reason: There's no "rstudio" user. (Fun fact: When you run an r-base container you are actually logged in as root.)

--

For non-Rstudio+ containers, I recommend a general strategy of mounting external volumes on the dedicated `/mnt` directory that is standard on Linux.<sup>1</sup> For example:

```
$ docker run -it --rm -v /home/grant/coolproject:/mnt/coolproject r-base /bin/bash
root@958d28472eb0:/# cd /mnt/coolproject/ 
root@958d28472eb0:/mnt/coolproject# R
```


.footnote[
<sup>1</sup> Remember, Docker images are basically just miniaturized, portable Linux OSs.
]


---
class: inverse, center, middle
name: next

# Next steps
<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

---

# Further reading

- [Rocker website](https://www.rocker-project.org/)
- [Docker documentation](https://docs.docker.com/)
- [Using Docker for Data Science](https://www.robertmylesmcdonnell.com/content/posts/docker/) (Very thorough walkthrough, with a focus on composing your own Dockerfiles from scratch.)
- [ROpenSci Docker Tutorial](http://ropenscilabs.github.io/r-docker-tutorial) (Another detailed and popular tutorial, albeit outdated in parts.)

---
class: inverse, center, middle

# Next class: Cloud computing with Google Compute Engine
<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>


```{r gen_pdf, include = FALSE, cache = FALSE, eval = TRUE}
infile = list.files(pattern = '.html')
pagedown::chrome_print(input = infile, timeout = 100)
```